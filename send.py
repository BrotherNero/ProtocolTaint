#-*- coding:utf-8 -*-

import random
import socket
import time
import sys

modbus = [
    "\x01\x11\x00\x00\x00\x06\x01\x03\x00\x02\x00\x08",
    "\x01\x11\x00\x00\x00\x06\x01\x03\x00\x02\x00\x01",
    "\x01\x11\x00\x00\x00\x06\x01\x03\x01\xc0\x00\x01",
    "\x20\x01\x00\x00\x00\x06\xff\x01\x00\x00\x00\x01",
    "\x00\x01\x00\x00\x00\x06\xff\x02\x00\x00\x00\x01",
    "\x00\x01\x00\x00\x00\x06\xff\x03\x00\x00\x00\x01",
    "\x00\x01\x00\x00\x00\x06\xff\x04\x00\x00\x00\x01",
    "\x00\x01\x00\x00\x00\x06\xff\x05\x00\x00\xff\x00",
    "\x00\x01\x00\x00\x00\x06\xff\x06\x00\x01\x00\x03",
    "\x00\x01\x00\x00\x00\x08\xff\x0f\x00\x01\x00\x01\x01\x01",
    "\x00\x01\x00\x00\x00\x09\xff\x10\x00\x01\x00\x01\x02\x00\x0a"
]

modbustest = [0x01,0x11,0x00,0x00,0x00,0x06,0x01,0x03,0x00,0x01,0x00,0x01]

dnp3 = [
    "\x05\x64\x12\x44\x64\x00\x01\x00\xd6\x03\xc5\xc4\x81\x00\x00\x29\x02\x17\x01\x01\xa4\x4c\x00\x69\x13",
    "\x05\x64\x10\xc4\x01\x00\x64\x00\x09\x9b\xc6\xc5\x03\x29\x02\x17\x01\x02\xa5\x4c\x00\xc2\xd1",
    "\x05\x64\x12\x44\x64\x00\x01\x00\xd6\x03\xc6\xc5\x81\x00\x00\x29\x02\x17\x01\x02\xa5\x4c\x00\x3a\x0d",
    "\x05\x64\x10\xc4\x01\x00\x64\x00\x09\x9b\xc7\xc6\x04\x29\x02\x17\x01\x02\xa5\x4c\x00\x26\x4d",
    "\x05\x64\x12\x44\x64\x00\x01\x00\xd6\x03\xc7\xc6\x81\x00\x00\x29\x02\x17\x01\x02\xa5\x4c\x00\x51\x2a",
    "\x05\x64\x10\xc4\x01\x00\x64\x00\x09\x9b\xc8\xc7\x03\x29\x02\x17\x01\x03\xa6\x4c\x00\x0b\x31",
    "\x05\x64\x12\x44\x64\x00\x01\x00\xd6\x03\xc8\xc7\x81\x00\x00\x29\x02\x17\x01\x03\xa6\x4c\x00\x64\x9d",
    "\x05\x64\x10\xc4\x01\x00\x64\x00\x09\x9b\xc9\xc8\x04\x29\x02\x17\x01\x03\xa6\x4c\x00\x93\x8e",
    "\x05\x64\x12\x44\x64\x00\x01\x00\xd6\x03\xc9\xc8\x81\x00\x00\x29\x02\x17\x01\x03\xa6\x4c\x00\x36\x16",
    "\x05\x64\x10\xc4\x01\x00\x64\x00\x09\x9b\xca\xc9\x03\x29\x02\x17\x01\x04\xa7\x4c\x00\x04\x3b",
    "\x05\x64\x12\x44\x64\x00\x01\x00\xd6\x03\xca\xc9\x81\x00\x00\x29\x02\x17\x01\x04\xa7\x4c\x00\x4e\xd4",
    "\x05\x64\x10\xc4\x01\x00\x64\x00\x09\x9b\xcb\xca\x04\x29\x02\x17\x01\x04\xa7\x4c\x00\xe0\xa7",
    "\x05\x64\x12\x44\x64\x00\x01\x00\xd6\x03\xcb\xca\x81\x00\x00\x29\x02\x17\x01\x04\xa7\x4c\x00\x25\xf3",
]

cip = [
    "\x70\x00\x3a\x00\x00\x01\x02\x10\x00\x00\x00\x00\x1a\x39\x2f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0a\x00\x02\x00\xa1\x00\x04\x00\x09\x13\x35\x00\xb1\x00\x26\x00\xe4\x6a\x0a\x02\x20\x02\x24\x01\x02\x00\x06\x00\x12\x00\x4c\x02\x20\x72\x24\x00\x00\xce\x04\x00\x01\x00\x4c\x02\x20\x72\x24\x00\x2c\x3d\x04\x00\x01\x00\x0a\x02\x20\x02\x24\x01\x02\x00\x06\x00\x12\x00\x4c\x02\x20\x72\x24\x00\x00\xce\x04\x00\x01\x00\x4c\x02\x20\x72\x24\x00\x2c\x3d\x04\x00\x01\x00",
    "\x03\x02\x20\x73\x24\x01\x01\x00\x05\x00"
]

s7 = [
    "\x03\x00\x00\x1f\x02\xf0\x80\x32\x01\x00\x00\x00\x00\x00\x0e\x00\x00\x04\x01\x12\x0a\x10\x02\x00\x04\x00\x01\x84\x00\x00\x00"
]

proto = sys.argv[1]

if proto == "dnp3":
    data = dnp3
    port = 4999
elif proto == "cip":
    data = cip
    port = 44818
elif proto == "modbus":
    data = modbus
    port = 502
elif proto == "s7":
    data = s7
    port = 102

ip = "127.0.0.1"

if len(sys.argv) >= 4:
    port = int(sys.argv[3])

print port

def connect(ip, port):
    sock = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    try:
        sock.connect((ip, port))
        print("The connection is successful!")
        return sock
    except:
        print("The connection failed!")
        return False

def wait_connect(ip, port):
    while 1:
        sock = connect(ip, port)
        if sock: break
        time.sleep(0.5)
    return sock


def main():
    if len(sys.argv) < 3:
        index = 0
    else:
        index = int(sys.argv[2]) 
    while 1:
        sock = wait_connect(ip, port)
        d = data[index]
        sock.send(d)
        print("send {}".format(" ".join(hex(ord(c)) for c in d)))
        print("recv {}".format(" ".join(hex(ord(c)) for c in sock.recv(64))))
        sock.close()
        _ = raw_input("wait....")
        index += 1

main()
